# Архитектура Vita

## Общая схема

Архитектура системы Vita представляет собой гибридную структуру, объединяющую центральный узел (мозг), edge-модули и систему автоматизации. Все компоненты взаимодействуют через протоколы MQTT и REST API, обеспечивая высокую производительность и надежность.

```
                    ┌─────────────────────────────────────┐
                    │         Система автоматизации       │
                    │         (Home Assistant)            │
                    └─────────────┬───────────────────────┘
                                  │
                    ┌─────────────▼───────────────────────┐
                    │         Центральный узел            │
                    │              Vita                   │
                    │     (mini-PC / ноутбук)             │
                    └───┬─────────────┬───────────────────┘
                        │             │
         ┌──────────────▼──┐ ┌────────▼──────────────┐
         │  Edge-модули    │ │   Edge-модули         │
         │    "Зрение"     │ │    "Сенсоры"          │
         │                 │ │                       │
         │ Orange Pi 5     │ │ ESP32 / Zigbee / BLE  │
         │ Jetson Nano     │ │ Датчики               │
         └─────────────────┘ └───────────────────────┘
```

## Компоненты

### Центральный узел (Мозг)
- **Hardware**: mini‑PC или ноутбук (64-128GB RAM)
- **LLM Engine**: llama.cpp / AirLLM
- **Функции**: Логика, память, обработка естественного языка

### Edge-модули "Зрение"
- **Hardware**: Orange Pi 5 Ultra, Jetson Nano 2 (8-16GB RAM)
- **CV Engine**: Frigate, YOLO, CLIP
- **Функции**: Компьютерное зрение, детекция объектов

### Edge-модули "Сенсоры"
- **Hardware**: ESP32, Zigbee, BLE
- **Engine**: MQTT, ESPHome
- **Функции**: Сбор данных с датчиков, управление устройствами

### Автоматизация
- **Platform**: Home Assistant, Node‑RED
- **Функции**: Сценарии, уведомления, интеграции

## Взаимодействие компонентов

### Центральный узел ↔ Edge-модули
- **Протокол**: MQTT / REST API
- **Направление**: Двустороннее
- **Частота**: По событиям / Периодически
- **Данные**: Команды, статусы, события

### Центральный узел ↔ Home Assistant
- **Протокол**: REST API / WebSocket
- **Направление**: Двустороннее
- **Частота**: По событиям / Периодически
- **Данные**: Команды, статусы, события

### Edge-модули ↔ Home Assistant
- **Протокол**: MQTT
- **Направление**: Одностороннее (модули → HA)
- **Частота**: По событиям
- **Данные**: События, статусы

## Пример взаимодействия

### Сценарий 1: Обнаружение движения камерой
```
1. Камера (Edge-модуль "Зрение") → Frigate обнаруживает движение
2. Frigate → Отправляет MQTT сообщение
3. Home Assistant → Получает событие
4. Home Assistant → Запрашивает анализ у Vita (REST API)
5. Vita → Обрабатывает запрос через llama.cpp
6. Vita → Возвращает ответ Home Assistant
7. Home Assistant → Выполняет действия (освещение, уведомления)
```

### Сценарий 2: Голосовая команда
```
1. Микрофон → Захват аудиосигнала
2. Whisper (Vita) → Преобразование речи в текст
3. Qwen3-Omni (Vita) → Анализ команды и контекста
4. Vita → Отправляет команды Home Assistant (REST API)
5. Home Assistant → Выполняет действия
6. Piper (Vita) → Преобразование ответа в речь
7. Динамики → Воспроизведение ответа
```

### Сценарий 3: Изменение температуры
```
1. Датчик температуры (Edge-модуль "Сенсоры") → Отправляет данные
2. MQTT → Передача данных в Home Assistant
3. Home Assistant → Анализирует значения
4. Home Assistant → При необходимости отправляет команды Vita
5. Vita → Принимает решение о действиях
6. Vita → Отправляет команды управления (REST API)
7. Home Assistant → Выполняет регулировку климата
```

## Потоки данных

### Голосовой ассистент
Поток данных голосового ассистента:
1. **Микрофон** - захват аудиосигнала
2. **Whisper STT** - преобразование речи в текст
3. **Vita (LLM)** - обработка текста и генерация ответа
4. **Piper TTS** - преобразование текста в речь
5. **Динамики** - воспроизведение аудиоответа

### Видеоаналитика
Поток данных видеоаналитики:
1. **Камера** - захват видеопотока
2. **Frigate** - обнаружение объектов и событий
3. **MQTT** - передача событий в систему
4. **Vita** - обработка событий и принятие решений
5. **Home Assistant** - выполнение действий
6. **TTS/Уведомления** - информирование пользователя

### Сенсорные данные
Поток данных от сенсоров:
1. **Датчики** - сбор данных о температуре, движении и других параметрах
2. **MQTT/ESPHome** - передача данных в систему
3. **Vita** - обработка данных и принятие решений
4. **Home Assistant** - выполнение действий
5. **Автоматизация** - выполнение сценариев и правил